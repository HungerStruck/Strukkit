From 506127715275f75f310410f84435a79ee91dc0e3 Mon Sep 17 00:00:00 2001
From: Kailan Blanks <kailan@kmp.pw>
Date: Sat, 2 Apr 2016 17:25:44 +0100
Subject: [PATCH] Implement ParticleBuilder API


diff --git a/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java b/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
index 4b5a3b3..3bc6d59 100644
--- a/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
+++ b/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
@@ -1,5 +1,7 @@
 package org.bukkit.craftbukkit.entity;
 
+import co.enviark.struckbukkit.effects.ParticleBuilder;
+
 import com.google.common.base.Objects;
 import com.google.common.base.Preconditions;
 import com.google.common.collect.ImmutableSet;
@@ -95,6 +97,10 @@ public class CraftPlayer extends CraftHumanEntity implements Player {
     private boolean showInvisibles;
     private PlayerResourcePackStatusEvent.Status resourcePackStatus;
     private String resourcePackHash;
+    
+    // struckbukkit start
+    private final Player.Particles particles;
+    // struckbukkit end
 
     private final Map<CommandSender, String> fakeNames = new WeakHashMap<CommandSender, String>();
     private final Map<CommandSender, String> fakeDisplayNames = new WeakHashMap<CommandSender, String>();
@@ -105,6 +111,9 @@ public class CraftPlayer extends CraftHumanEntity implements Player {
 
         firstPlayed = System.currentTimeMillis();
         this.realSkin = this.getSkin();
+        // struckbukkit start
+        particles = new Particles();
+        // struckbukkit end
     }
 
     public GameProfile getProfile() {
@@ -1964,4 +1973,35 @@ public class CraftPlayer extends CraftHumanEntity implements Player {
     public int getProtocolVersion() {
         return 107;
     }
+
+    // struckbukkit start
+
+    @Override
+    public Player.Particles particles() {
+        return particles;
+    }
+
+    public class Particles implements Player.Particles {
+        public ParticleBuilder play(ParticleBuilder builder) {
+            if (builder.getLocation() == null)
+                throw new NullPointerException("ParticleBuilder location must not be null!");
+            Packet packet = new PacketPlayOutWorldParticles(CraftParticle.toNMS(builder.getParticle()), builder.isLongDistance(), (float) builder.getLocation().getX(), (float) builder.getLocation().getY(), (float) builder.getLocation().getZ(), builder.getOffsetX(), builder.getOffsetY(), builder.getOffsetZ(), builder.getSpeed(), builder.getCount(), builder.getData());
+
+            getHandle().playerConnection.sendPacket(packet);
+            return builder;
+        }
+
+        public ParticleBuilder playRGB(int r, int g, int b, ParticleBuilder builder) {
+            builder.setOffsetX((float) r / 255);
+            builder.setOffsetY((float) g / 255);
+            builder.setOffsetZ((float) b / 255);
+            builder.setSpeed(1f);
+            builder.setCount(0);
+
+            return play(builder);
+        }
+    }
+
+    // struckbukkit end
+
 }
-- 
2.7.2

